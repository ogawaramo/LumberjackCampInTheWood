# 機能仕様書（FSD）
**森のきこりキャンプ - Phase 1 実装仕様**

**文書バージョン**: 1.0
**最終更新**: 2025-11-16
**対象プラットフォーム**: VRChat（Unity 2022.3.22f1 / SDK 3.9.0 / UdonSharp 1.1.9）

---

## 目次

1. [FNC-001: 伐採システム](#fnc-001-伐採システム)
2. [FNC-002: 運搬システム](#fnc-002-運搬システム)
3. [FNC-003: 加工システム](#fnc-003-加工システム)
4. [FNC-004: スキル成長システム](#fnc-004-スキル成長システム)
5. [FNC-005: 経済システム](#fnc-005-経済システム)
6. [FNC-006: 協力・ソーシャル機能](#fnc-006-協力ソーシャル機能)

---

# FNC-001: 伐採システム

## 1. 仕様概要

- **機能ID:** `FNC-001`

- **機能名:** 伐採システム（Woodcutting System）

- **背景と目的:**
  - VRChatワールド「森のきこりキャンプ」の中核となる体験を提供する機能である
  - Valheimの木こり作業の気持ちよさ（斧で木を叩く → 倒れる → 丸太が出る）をVRで再現する
  - 複数プレイヤーでの協力伐採により、自然な会話のきっかけを創出する
  - PRDの「継続性の欠如」「会話のきっかけ不足」「協力プレイの必然性不足」という課題を解決する

- **成功指標:**
  - 初回訪問者の80%が木を1本以上伐採できる（操作の直感性）
  - 協力伐採ボーナス発動率が全伐採の30%以上（協力プレイの促進）
  - 木を伐採する際のレスポンス時間が100ms以内（気持ちよさの確保）
  - Quest 2環境で複数人が同時伐採しても60fps維持（パフォーマンス）

## 2. ユーザーとシナリオ

- **対象ユーザー:**
  - プライマリ：VRChatで「まったり雑談」を好むユーザー、Valheim/Minecraft愛好者
  - セカンダリ：VRChat初心者（簡単な操作で楽しめる）

- **ユーザーストーリー:**
  - `As a VRChatユーザー, I want to 斧で木を叩いて倒す体験をしたい, so that Valheimのような気持ちよさをVRで味わえる.`
  - `As a 協力プレイ好きなユーザー, I want to 他のプレイヤーと一緒に木を切りたい, so that 会話しながら作業できて楽しい.`
  - `As a VRChat初心者, I want to 簡単な操作で木を切れるようにしたい, so that すぐに遊び始められる.`

## 3. 機能要件

### 3.1. 機能の振る舞い

#### 正常系 (Happy Path)

1. **木の発見**
   - ユーザーがワールド内の森エリアに移動すると、立木オブジェクト（Pine/Oak/Ancient）が視認できる
   - 木には3種類あり、サイズと外観で区別できる：小（Pine）、中（Oak）、大（Ancient）

2. **斧の取得**
   - ユーザーがキャンプ中央の斧置き場に近づき、VRではグリップボタン、デスクトップではEキーを押すと、斧を手に取れる
   - 初期装備として「木の斧」（基礎ダメージ10）が提供される

3. **伐採アクション**
   - ユーザーがVRではトリガーボタン、デスクトップでは左クリックで斧をスイングする
   - 斧のコライダーが木のコライダーと衝突すると、以下が発生する：
     - 木のHP減少（ダメージ = 基礎ダメージ × (1 + スキルレベル × 0.05) × 斧倍率）
     - ヒットエフェクト（木片パーティクル、衝撃音）
     - ダメージ数値の表示（木の上部に1秒間表示）

4. **協力伐採**
   - 2人以上のユーザーが同じ木を3秒以内に攻撃すると、協力伐採モードが発動する
   - 木の上に「握手マーク」アイコンが表示される
   - 協力中のダメージとXPに+20%ボーナスが適用される
   - 金色のヒットエフェクトと「キラーン」という特殊効果音が再生される

5. **倒木**
   - 木のHPが0になると、以下の処理が順次実行される：
     - 「ミシミシ」というきしみ音が再生される
     - 最後の一撃を与えたユーザーの位置から木への方向ベクトルの反対方向に倒木アニメーション開始
     - 2秒かけて回転しながら倒れる（簡易的な回転アニメーション）
     - 地面に接触時に「バキッ」「ドサッ」という音と土煙パーティクルが発生
     - 木の状態が[Fallen]に遷移

6. **丸太生成**
   - 倒木状態の木をさらに斧で叩くと、以下が発生する：
     - 倒木のHP（立木の50%）が減少
     - HP=0で丸太オブジェクトが倒木の中心から1m間隔でスポーン
     - 生成数：小さい木1〜2本、中くらい2〜3本、大きい3〜4本
     - 各丸太に少しランダムな力を加えて自然に散らばる
     - 倒木オブジェクトが非アクティブ化

7. **木のリスポーン**
   - 伐採完了後、リスポーンタイマーが開始される（小3分、中5分、大10分）
   - タイマー完了時、元の位置に木が再生成される
   - リスポーン時に薄い緑色のパーティクル演出

8. **スキル経験値獲得**
   - 木を伐採完了すると、Woodcuttingスキル経験値を獲得する：
     - 小さい木：10 XP
     - 中くらいの木：20 XP
     - 大きな木：40 XP
     - 協力伐採時：上記+20%

#### 異常系 (Error/Edge Cases)

- **ケース1: 斧を持たずに木を攻撃**
  - **トリガー:** ユーザーが斧を装備していない状態で木に触れる
  - **システムの振る舞い:** 何も起こらない。HUDに「斧を装備してください」というメッセージが2秒間表示される

- **ケース2: 攻撃クールダウン中のスイング**
  - **トリガー:** ユーザーが前回のスイングから0.5秒以内に再度攻撃しようとする
  - **システムの振る舞い:** スイングアニメーションは再生されるが、ダメージは発生しない（連打防止）

- **ケース3: 同時伐採による競合**
  - **トリガー:** 木のHPが10残っている状態で、2人のユーザーがほぼ同時に10以上のダメージを与える
  - **システムの振る舞い:** 最初にヒット判定が確定したユーザーの攻撃でHP=0とし、倒木処理を開始。2番目のユーザーの攻撃は無効化される（二重処理防止）

- **ケース4: 丸太の最大数超過**
  - **トリガー:** マップ上に既に30個の丸太が存在する状態で、新たに丸太が生成される
  - **システムの振る舞い:** 最も古い丸太から順に削除され、新しい丸太がスポーンされる（パフォーマンス維持）

- **ケース5: 倒木中の木への攻撃**
  - **トリガー:** 木が倒木アニメーション中（状態が[Falling]）にユーザーが攻撃する
  - **システムの振る舞い:** 攻撃は無効化され、何も起こらない（状態が[Fallen]になるまで待機）

- **ケース6: Master Clientの退出**
  - **トリガー:** 木の状態を管理しているMaster Clientがワールドから退出する
  - **システムの振る舞い:** 新しいMaster Clientに木の状態（HP、倒木フラグ、リスポーンタイマー）が自動的に引き継がれる（UdonSyncedによる同期）

## 4. UI/UXフロー

- **画面遷移:**
  1. ユーザーがワールドに入場すると、チュートリアル看板が表示される（初回のみ）
  2. ユーザーが斧置き場に近づくと、「斧を取る [E]」というプロンプトが表示される
  3. ユーザーが斧を取ると、HUD左下に「木の斧」アイコンと「Woodcutting Lv1」が表示される
  4. ユーザーが木に近づくと、木の上部にHP バー（緑色）が表示される
  5. ユーザーが木を攻撃すると、ダメージ数値（「-12」など）が木の上に浮遊表示される
  6. 協力伐採発動時、木の上に握手マークアイコンが表示され、HPバーが金色に変化する
  7. 木のHPが30%以下になると、HPバーが黄色に変化し、「ミシミシ」という音が鳴る
  8. HP=0で倒木アニメーション、完了後にHPバー非表示
  9. ユーザーが倒木を攻撃すると、倒木のHPバー（オレンジ色）が表示される
  10. 丸太生成時、獲得XPと獲得コインが画面中央上部に通知表示される（「Woodcutting +10 XP」「+5コイン」）

- **関連ワイヤーフレーム:**
  - N/A（Phase 1ではワイヤーフレーム作成をスコープ外とする。実装時にUnity内で直接UI配置を調整）

## 5. データ要件

- **主要データエンティティ:**

  - **エンティティ名:** Tree（木）
    - **主要属性:**
      - `treeID` (int): 木の一意識別子（0〜29）
      - `treeType` (enum): 木の種類（Pine=0, Oak=1, Ancient=2）
      - `currentHP` (int): 現在のHP（0〜100）
      - `maxHP` (int): 最大HP（Pine=30, Oak=60, Ancient=100）
      - `state` (enum): 状態（Standing=0, Falling=1, Fallen=2）
      - `position` (Vector3): 配置位置
      - `respawnTimer` (float): リスポーンまでの残り時間（秒）

  - **エンティティ名:** Axe（斧）
    - **主要属性:**
      - `axeID` (int): 斧の種類（Wood=1, Iron=2, DarkSteel=3）
      - `baseDamage` (int): 基礎ダメージ（10/15/20）
      - `attackSpeed` (float): 攻撃速度（1.0/0.9/0.8秒）
      - `criticalRate` (float): クリティカル率（0%/0%/10%）

  - **エンティティ名:** Log（丸太）
    - **主要属性:**
      - `logID` (int): 丸太の一意識別子
      - `spawnTime` (float): 生成時刻（Time.time）
      - `position` (Vector3): 現在位置
      - `isPickedUp` (bool): 誰かが持っているか

  - **エンティティ名:** PlayerWoodcuttingData（プレイヤー伐採データ）
    - **主要属性:**
      - `skillLevel` (int): Woodcuttingスキルレベル（1〜10）
      - `currentXP` (int): 現在のXP（0〜10500）
      - `totalTreesCut` (int): 累計伐採数
      - `equippedAxeID` (int): 装備中の斧ID
      - `lastAttackTime` (float): 最後の攻撃時刻（クールダウン管理用）
      - `cooperativeTreeID` (int): 協力伐採中の木ID（-1=なし）

- **入力バリデーション:**

  - **項目名:** treeID（木の攻撃対象）
    - **ルール:**
      - 必須入力
      - 0〜29の範囲内であること
      - 対象の木が存在すること（state != null）

  - **項目名:** attackDamage（ダメージ量）
    - **ルール:**
      - 正の整数であること
      - 1〜1000の範囲内であること（異常値防止）

  - **項目名:** respawnTimer（リスポーンタイマー）
    - **ルール:**
      - 0以上の実数であること
      - 木の種類に応じた最大値以下であること（Pine=180秒、Oak=300秒、Ancient=600秒）

## 6. 外部連携

- **VRChat Persistence API（PlayerData）**
  - **目的:** プレイヤーのWoodcuttingスキルレベル、XP、累計伐採数を永続化
  - **主要なやり取り:**
    - ワールド入場時：`PlayerData.GetInt("Woodcutting_Level")` でレベル読み込み
    - XP獲得時：`PlayerData.SetInt("Woodcutting_XP", newXP)` でXP保存
    - 退出時：全データを自動保存（VRChat SDK標準機能）
  - **制約:** 1プレイヤーあたり100KB制限（本機能の使用量：約50バイト）

- **VRChat UdonSync（ネットワーク同期）**
  - **目的:** 木のHP、倒木状態、協力伐採状態をインスタンス内の全プレイヤーに同期
  - **主要なやり取り:**
    - 木へのダメージ：`[UdonSynced] int[] treeHPs` 配列を更新
    - 倒木：`[UdonSynced] bool[] treeFallen` フラグを true に設定
    - 協力伐採：`[UdonSynced] int[] cooperativeHitTimestamps` を更新
  - **制約:** 帯域幅10KB/秒以下を維持する必要がある

## 7. 非機能要件（プロトタイプ向け抜粋）

- **性能:**
  - 主要なユーザー操作（斧スイング、ダメージ計算）は100ms以内に応答を返すこと
  - Quest 2環境で10人が同時に伐採しても60fps維持すること
  - 木の状態更新（HP減少、倒木判定）は、UdonのUpdate()ループを避け、イベント駆動で実装すること

- **セキュリティ:**
  - クライアント側で改ざん可能な値（ダメージ量、XP獲得量）は、サーバー側（Master Client）で検証すること
  - 異常なダメージ値（1000以上）は自動的に無効化すること

- **可用性:**
  - Master Clientの退出時、新しいMaster Clientへの状態引き継ぎが5秒以内に完了すること
  - 状態引き継ぎ中も、他のプレイヤーは伐採を継続できること（一時的な同期遅延は許容）

- **ユーザビリティ:**
  - VR初心者でも5分以内に木を1本伐採できるよう、チュートリアル看板を配置すること
  - 斧のスイングアニメーションは、VR酔いを防ぐため過度に速くしないこと（0.5秒以上の持続時間）

## 8. 前提条件・制約事項・スコープ外

- **前提条件:**
  - ユーザーはVRChatアカウントを持ち、ワールドに入場できる状態であること
  - ユーザーのクライアントは、VRChat SDK 3.9.0に対応していること
  - Unity 2022.3.22f1でビルドされたワールドであること

- **制約事項:**
  - 同時接続プレイヤー数の上限は20人（VRChat標準制限）
  - 木の最大配置数は30本（パフォーマンス制約）
  - 丸太の最大同時存在数は30個（メモリ制約）
  - UdonSharpの実行速度はC#の200〜1000倍遅いため、重いループ処理は避けること

- **スコープ外 (Phase 1では実装しないこと):**
  - 斧以外の伐採ツール（のこぎり、チェーンソーなど）
  - 木の成長システム（苗木から成木への成長）
  - 木の種類の追加（Phase 1はPine/Oak/Ancientの3種のみ）
  - 木の品質システム（レア木材、特殊木材など）
  - 天候による伐採効率の変化（雨、雪など）
  - 伐採音のカスタマイズ
  - 倒木方向の手動制御（常にプレイヤーと反対方向に倒れる）

---

# FNC-002: 運搬システム

## 1. 仕様概要

- **機能ID:** `FNC-002`

- **機能名:** 運搬システム（Carrying System）

- **背景と目的:**
  - 伐採で得た丸太をキャンプまで運び、コインを獲得するサイクルを提供する
  - 丸太運搬中の移動速度デバフにより、「重さ」を体感させる
  - 運搬距離に応じた報酬により、プレイヤーの努力を適切に評価する
  - PRDの「作業しながら会話を楽しむ」という体験を実現する（運搬中も会話可能）

- **成功指標:**
  - 初回訪問者の70%が丸太を1本以上納品できる
  - 平均運搬距離が50メートル以上（遠くの森から運ぶ動機）
  - 運搬中のFPS低下が5%以内（Quest 2環境）

## 2. ユーザーとシナリオ

- **対象ユーザー:**
  - プライマリ：伐採を完了したすべてのユーザー
  - セカンダリ：効率的にコインを稼ぎたいユーザー

- **ユーザーストーリー:**
  - `As a ユーザー, I want to 伐採した丸太を簡単に掴んで運びたい, so that スムーズに次の作業に移れる.`
  - `As a ユーザー, I want to 丸太を遠くから運ぶほど多くのコインを得たい, so that 努力が報われる.`
  - `As a ユーザー, I want to 運搬中も他のプレイヤーと会話したい, so that 作業が退屈にならない.`

## 3. 機能要件

### 3.1. 機能の振る舞い

#### 正常系 (Happy Path)

1. **丸太のPickup**
   - ユーザーが丸太オブジェクトに近づき（0.5m以内）、VRではグリップボタン、デスクトップではEキーを押す
   - 丸太がユーザーの手（VR）またはカメラ前（デスクトップ）に固定される
   - 移動速度が15%減少する（baseSpeed 4.0m/s → 3.4m/s）
   - HUD右下に「丸太運搬中」アイコンと運搬開始位置からの距離が表示される

2. **運搬**
   - ユーザーが丸太を持った状態で移動すると、運搬距離がリアルタイムで計測される
   - 10メートル移動ごとにHUDに距離通知（「20m運搬中...」）
   - 足音が通常より重い音に変化する

3. **納品ゾーンでのDrop**
   - ユーザーがキャンプ中央の納品エリア（5m × 5m × 3mのボックス）に入る
   - エリア内で丸太をDrop（VRではグリップ離す、デスクトップではEキー）すると、以下が発生：
     - 丸太が1秒後に吸い込まれるアニメーション（縮小しながら上昇）で消滅
     - 運搬距離に応じたコイン付与（10m = 3コイン、最大100m = 30コイン）
     - チャリーンという納品音
     - 画面中央上部に「+15コイン」通知表示
     - インスタンス内の納品カウント+1（ランキング用）

4. **報酬計算**
   - コイン = min(floor(運搬距離 / 10) × 3, 30)
   - 例：35m運搬 → floor(35/10) × 3 = 9コイン
   - 例：120m運搬 → 上限30コイン

#### 異常系 (Error/Edge Cases)

- **ケース1: 納品エリア外でのDrop**
  - **トリガー:** ユーザーが納品エリア外で丸太をDropする
  - **システムの振る舞い:** 丸太はその場に落下し、物理演算で地面に転がる。コインは獲得できない。HUDに「納品エリアに運んでください」というメッセージが2秒間表示される

- **ケース2: 運搬中のワールド退出**
  - **トリガー:** ユーザーが丸太を持ったままワールドから退出する
  - **システムの振る舞い:** 丸太は自動的にDropされ、元の位置（伐採地点）に戻る。コインは獲得できない

- **ケース3: 丸太の同時Pickup試行**
  - **トリガー:** 2人のユーザーがほぼ同時に同じ丸太をPickupしようとする
  - **システムの振る舞い:** 先にPickupリクエストが確定したユーザーが丸太を取得。後のユーザーには「すでに誰かが持っています」というメッセージが表示される

- **ケース4: 丸太を持ったままシーン境界外へ**
  - **トリガー:** ユーザーが丸太を持ったままマップの境界線を超える
  - **システムの振る舞い:** ユーザーがマップ内に戻されると同時に、丸太は自動的にDropされる

## 4. UI/UXフロー

- **画面遷移:**
  1. ユーザーが丸太に近づくと、「丸太を掴む [E]」というプロンプトが表示される
  2. Pickup時、HUD右下に「丸太運搬中 (0m)」と丸太アイコンが表示される
  3. 移動に伴い、距離がリアルタイム更新される（「丸太運搬中 (23m)」）
  4. 納品エリアに入ると、エリアの枠線が緑色に光り、「ここで離してください」というメッセージが表示される
  5. Drop時、コイン獲得アニメーション（金色のパーティクルがユーザーに向かって飛ぶ）
  6. HUD左下のコイン残高が増加するカウントアップアニメーション

## 5. データ要件

- **主要データエンティティ:**

  - **エンティティ名:** Log（丸太）
    - **主要属性:**
      - `isPickedUp` (bool): 誰かが持っているか
      - `currentOwner` (VRCPlayerApi): 現在の所有者
      - `pickupStartPosition` (Vector3): Pickup開始位置
      - `totalCarriedDistance` (float): 累計運搬距離

  - **エンティティ名:** DeliveryZone（納品ゾーン）
    - **主要属性:**
      - `zonePosition` (Vector3): エリア中心位置
      - `zoneSize` (Vector3): エリアサイズ（5m × 5m × 3m）
      - `totalDeliveries` (int): インスタンス内の総納品数

  - **エンティティ名:** PlayerCarryingData（プレイヤー運搬データ）
    - **主要属性:**
      - `isCarrying` (bool): 現在運搬中か
      - `carriedLogID` (int): 運搬中の丸太ID
      - `startPosition` (Vector3): 運搬開始位置
      - `currentSpeed` (float): 現在の移動速度

- **入力バリデーション:**

  - **項目名:** carriedDistance（運搬距離）
    - **ルール:**
      - 0以上の実数であること
      - 1000メートル以下であること（異常値防止）

  - **項目名:** deliveryZoneCollision（納品エリア判定）
    - **ルール:**
      - 丸太の位置がBoxCollider内であること
      - 丸太がPickup状態でないこと（Dropされていること）

## 6. 外部連携

- **VRChat VRC_Pickup コンポーネント**
  - **目的:** 丸太のPickup/Drop機能を提供
  - **主要なやり取り:**
    - `VRC_Pickup.OnPickup()` イベントで運搬開始処理
    - `VRC_Pickup.OnDrop()` イベントで運搬終了・報酬計算
  - **制約:** AutoHold = Off（トリガー離すとDrop）

- **VRChat Persistence API（PlayerData）**
  - **目的:** 累計運搬距離、累計獲得コインを保存
  - **主要なやり取り:**
    - 納品時：`PlayerData.SetInt("TotalCoinsEarned", totalCoins)` で更新

## 7. 非機能要件（プロトタイプ向け抜粋）

- **性能:**
  - 丸太のPickup/Drop処理は50ms以内に完了すること
  - 運搬距離の計測は、Updateループではなく0.5秒ごとのタイマーで実行すること（CPU負荷軽減）

- **ユーザビリティ:**
  - 丸太のPickup判定範囲は0.5mとし、直感的に掴めるようにすること
  - 運搬中の移動速度デバフは15%に抑え、ストレスにならないようにすること

## 8. 前提条件・制約事項・スコープ外

- **前提条件:**
  - ユーザーがFNC-001（伐採システム）で丸太を生成済みであること

- **制約事項:**
  - 1人のユーザーが同時に運搬できる丸太は1本のみ
  - 丸太の最大運搬距離は100m（それ以上はコイン増加なし）

- **スコープ外 (Phase 1では実装しないこと):**
  - 太丸太協力運搬（2人以上で運ぶシステム）→ Phase 2
  - Carryingスキルの成長 → Phase 2
  - 運搬用の道具（カート、ロープなど）
  - 丸太の品質による報酬差（すべて同じ報酬）

---

# FNC-003: 加工システム

## 1. 仕様概要

- **機能ID:** `FNC-003`

- **機能名:** 加工システム（Processing System）

- **背景と目的:**
  - 丸太を板材に変換する基本的なクラフト体験を提供する
  - 加工中の待ち時間（3秒）を利用して、プレイヤー間の会話を促進する
  - 板材を使った装飾アイテム作成により、キャンプのカスタマイズ性を高める
  - Phase 2での複雑なクラフトシステムへの基盤を構築する

- **成功指標:**
  - 初回訪問者の50%が丸太を板材に加工する
  - 加工操作の平均完了時間が5秒以内（操作の簡便性）

## 2. ユーザーとシナリオ

- **対象ユーザー:**
  - プライマリ：丸太を運搬したすべてのユーザー
  - セカンダリ：キャンプを装飾したいユーザー

- **ユーザーストーリー:**
  - `As a ユーザー, I want to 丸太を板材に変換したい, so that 建築素材として使える.`
  - `As a ユーザー, I want to 加工中に他のプレイヤーと会話したい, so that 待ち時間が退屈にならない.`

## 3. 機能要件

### 3.1. 機能の振る舞い

#### 正常系 (Happy Path)

1. **切断台へのアクセス**
   - ユーザーがキャンプ内の切断台（1.5m × 0.8m × 0.9mの木製作業台）に近づく
   - 切断台の上部に丸太設置位置のガイド（溝）が表示されている

2. **丸太の配置**
   - ユーザーが丸太を持った状態で切断台に近づき、Dropする
   - 丸太が溝にスナップ（自動吸着）して正しい位置に配置される
   - UIボタン「加工開始」が切断台の前面に表示される

3. **加工処理**
   - ユーザーが「加工開始」ボタンをクリック（VRではトリガー、デスクトップでは左クリック）
   - 3秒のプログレスバーが表示される（円形、0%→100%）
   - のこぎりが自動で動くアニメーション（往復運動）
   - 加工音（ギコギコという音）が3秒間ループ再生

4. **板材生成**
   - プログレスバー完了時、以下が発生：
     - 丸太オブジェクトが消滅
     - 板材オブジェクト2枚が切断台の横にスポーン
     - カタンという板材生成音
     - 画面中央上部に「板材 × 2 を獲得」と通知表示
     - 板材はPickup可能な状態で配置される

5. **装飾アイテムのクラフト**
   - ユーザーが板材を5枚持って切断台の「クラフト」タブを開く
   - クラフト可能なアイテムリストが表示される（ベンチ、看板）
   - ユーザーが「ベンチ」を選択し、「作成」ボタンをクリック
   - 5秒のプログレスバー後、ベンチオブジェクトがスポーン
   - ベンチは配置可能な状態で、predefinedの建築ポイントに設置できる

#### 異常系 (Error/Edge Cases)

- **ケース1: 丸太を配置せずに加工開始**
  - **トリガー:** ユーザーが切断台に何も載せずに「加工開始」ボタンをクリック
  - **システムの振る舞い:** エラー音と「丸太を配置してください」というメッセージが表示される。処理は実行されない

- **ケース2: 加工中の丸太の取り上げ**
  - **トリガー:** ユーザーが加工プログレスバー進行中に丸太をPickupしようとする
  - **システムの振る舞い:** 丸太はPickup不可状態（固定）であり、取り上げられない。「加工中は移動できません」というメッセージが表示される

- **ケース3: 板材不足でのクラフト試行**
  - **トリガー:** ユーザーが板材3枚しか持っていない状態でベンチ（必要数5枚）のクラフトを試行
  - **システムの振る舞い:** 「板材が不足しています（3/5）」というエラーメッセージが表示される。クラフトは実行されない

## 4. UI/UXフロー

- **画面遷移:**
  1. ユーザーが切断台に近づくと、「切断台」というラベルが表示される
  2. 丸太をDropすると、丸太が溝にスナップし、「加工開始」ボタンが出現
  3. ボタンクリック時、プログレスバーとのこぎりアニメーション開始
  4. 完了時、板材が横にスポーンし、「板材 × 2」アイコンが表示される
  5. ユーザーが「クラフト」タブをクリックすると、クラフトメニューが開く
  6. クラフト可能アイテムは緑色、不可能（素材不足）はグレーアウト表示

## 5. データ要件

- **主要データエンティティ:**

  - **エンティティ名:** CuttingTable（切断台）
    - **主要属性:**
      - `isProcessing` (bool): 加工中フラグ
      - `placedLogID` (int): 配置された丸太ID（-1=なし）
      - `processStartTime` (float): 加工開始時刻
      - `processDuration` (float): 加工時間（3秒固定）

  - **エンティティ名:** Plank（板材）
    - **主要属性:**
      - `plankID` (int): 板材の一意識別子
      - `position` (Vector3): 配置位置

  - **エンティティ名:** CraftingRecipe（クラフトレシピ）
    - **主要属性:**
      - `recipeID` (int): レシピID（Bench=1, Sign=2）
      - `requiredPlanks` (int): 必要板材数（Bench=5, Sign=3）
      - `craftingTime` (float): クラフト時間（Bench=5秒, Sign=3秒）
      - `outputItemID` (int): 生成アイテムID

- **入力バリデーション:**

  - **項目名:** placedLog（配置された丸太）
    - **ルール:**
      - 丸太オブジェクトが存在すること
      - 切断台の溝の範囲内（±0.2m）に配置されていること

  - **項目名:** craftingMaterialCount（クラフト素材数）
    - **ルール:**
      - レシピの必要数以上であること
      - 保持している板材数と一致すること（不正防止）

## 6. 外部連携

- N/A（Phase 1では外部連携なし。すべてローカル処理）

## 7. 非機能要件（プロトタイプ向け抜粋）

- **性能:**
  - 加工プログレスバーは滑らかに更新されること（60fps）
  - 板材生成時のスポーン処理は100ms以内に完了すること

- **ユーザビリティ:**
  - 丸太のスナップ判定範囲は0.2mとし、自然に配置できること
  - プログレスバーは視認しやすい位置（切断台の上部）に表示すること

## 8. 前提条件・制約事項・スコープ外

- **前提条件:**
  - ユーザーがFNC-001（伐採）で丸太を生成済みであること

- **制約事項:**
  - 切断台は1台のみ（Phase 1）
  - 同時に加工できる丸太は1本のみ

- **スコープ外 (Phase 1では実装しないこと):**
  - 製材所（大量加工設備）→ Phase 2
  - Craftingスキルの成長 → Phase 2
  - 複雑なクラフトツリー（複数素材の組み合わせ）→ Phase 2
  - 板材の品質システム

---

# FNC-004: スキル成長システム

## 1. 仕様概要

- **機能ID:** `FNC-004`

- **機能名:** スキル成長システム（Progression System）

- **背景と目的:**
  - Woodcuttingスキルの成長により、プレイヤーの達成感と継続プレイのモチベーションを提供する
  - レベルアップによるダメージボーナスで、作業効率が向上する実感を与える
  - Persistenceを活用し、ログアウト後もスキルレベルが維持されることで、長期的な成長体験を実現する
  - PRDの「成長要素の不足」という課題を解決する

- **成功指標:**
  - 初回訪問者の50%がWoodcutting Lv5に到達する
  - レベルアップ時の満足度が高い（テストプレイでのフィードバック）
  - データ永続化の成功率が99%以上（ログアウト→再ログインでデータ維持）

## 2. ユーザーとシナリオ

- **対象ユーザー:**
  - プライマリ：すべてのユーザー（伐採を行うと自動的にXP獲得）
  - セカンダリ：やり込み志向のユーザー（Lv10到達を目指す）

- **ユーザーストーリー:**
  - `As a ユーザー, I want to 伐採するたびにスキルレベルが上がりたい, so that 成長を実感できる.`
  - `As a ユーザー, I want to レベルアップすると伐採が早くなりたい, so that 効率化の喜びを感じられる.`
  - `As a ユーザー, I want to ログアウトしてもスキルレベルが保存されていてほしい, so that 継続的に成長できる.`

## 3. 機能要件

### 3.1. 機能の振る舞い

#### 正常系 (Happy Path)

1. **XP獲得**
   - ユーザーが木を伐採完了すると、木の種類に応じたXPを獲得する：
     - 小さい木（Pine）：10 XP
     - 中くらいの木（Oak）：20 XP
     - 大きな木（Ancient）：40 XP
   - 協力伐採時は+20%ボーナス（例：Pine 10 XP → 12 XP）
   - HUD左下のWoodcuttingスキルXPバーが増加するアニメーション

2. **レベルアップ判定**
   - XP獲得後、現在XPが次レベルの必要XPに到達しているかチェック
   - レベルアップ条件を満たすと、以下が発生：
     - 画面中央に「LEVEL UP!」という大きな文字が2秒間表示
     - 金色のパーティクルがプレイヤーを包む
     - レベルアップ音（ファンファーレ）が再生
     - スキルレベルが1増加（Lv2 → Lv3）
     - HUDのスキルレベル表示が更新
     - 新しい特典がある場合、追加通知（「丸太生成数+1（10%確率）解禁！」）

3. **スキル効果の適用**
   - レベルアップ直後から、新しいダメージボーナスが適用される：
     - Lv1: +0%
     - Lv2: +5%
     - Lv3: +10%
     - ...
     - Lv10: +50%
   - 例：Lv5（+20%）で木の斧（基礎10）使用時 → ダメージ12

4. **特典解禁**
   - 特定レベルで以下の特典が解禁される：
     - Lv3: 丸太生成数+1（10%確率）
     - Lv5: クリティカル率5%
     - Lv6: 丸太生成数+1（20%確率）
     - Lv8: クリティカル率10%
     - Lv9: 丸太生成数+1（30%確率）
     - Lv10: マスター称号、特殊エフェクト

5. **データ永続化**
   - XP獲得時、PlayerDataに自動保存される：
     - `PlayerData.SetInt("Woodcutting_Level", currentLevel)`
     - `PlayerData.SetInt("Woodcutting_XP", currentXP)`
   - ワールド退出時、最終データが自動保存される
   - 次回入場時、`PlayerData.GetInt("Woodcutting_Level")` でレベル読み込み

6. **HUD表示**
   - 画面左下に常時表示：
     - `Woodcutting: Lv5 [■■■■■□□□□□] 450/700 XP`
   - XPバーは視覚的に進捗が分かりやすいデザイン
   - レベルアップ時、バーが満タンになった後リセットされ、次レベルのバーが表示

#### 異常系 (Error/Edge Cases)

- **ケース1: 最大レベル（Lv10）到達後のXP獲得**
  - **トリガー:** ユーザーがLv10の状態で木を伐採してXPを獲得
  - **システムの振る舞い:** XPは加算されるが、レベルは10のまま。「最大レベルに到達しています」というメッセージが表示される

- **ケース2: PlayerDataの読み込み失敗**
  - **トリガー:** ワールド入場時、Persistence APIからのデータ読み込みがエラーになる
  - **システムの振る舞い:** デフォルト値（Lv1、XP=0）でゲーム開始。エラーログを出力するが、ゲームプレイは継続可能

- **ケース3: 異常なXP値の検出**
  - **トリガー:** データ破損または改ざんにより、XPが負値または異常値（100万など）になる
  - **システムの振る舞い:** データをリセットし、Lv1・XP=0に戻す。「データが破損していたため初期化されました」というメッセージを表示

## 4. UI/UXフロー

- **画面遷移:**
  1. ワールド入場時、HUD左下にスキル情報が表示される
  2. 木伐採完了時、「+10 XP」という通知が画面中央上部に0.5秒表示
  3. XPバーが増加するアニメーション（0.5秒かけて滑らかに）
  4. レベルアップ時、画面全体に金色のフラッシュエフェクト
  5. 「LEVEL UP!」文字が中央に2秒表示
  6. 新しい特典がある場合、「丸太生成数+1（10%確率）解禁！」が追加表示

## 5. データ要件

- **主要データエンティティ:**

  - **エンティティ名:** SkillData（スキルデータ）
    - **主要属性:**
      - `skillLevel` (int): 現在のスキルレベル（1〜10）
      - `currentXP` (int): 現在のXP（0〜10500）
      - `damageBonus` (float): ダメージボーナス（0.0〜0.5）
      - `criticalRate` (float): クリティカル率（0.0〜0.15）
      - `logBonusRate` (float): 丸太生成数ボーナス確率（0.0〜0.3）

  - **エンティティ名:** LevelTable（レベルテーブル）
    - **主要属性:**
      - `level` (int): レベル（1〜10）
      - `requiredXP` (int): 次レベルまでの必要XP
      - `cumulativeXP` (int): 累計XP
      - `damageBonus` (float): ダメージボーナス

- **入力バリデーション:**

  - **項目名:** skillLevel（スキルレベル）
    - **ルール:**
      - 1〜10の範囲内であること
      - 整数であること

  - **項目名:** currentXP（現在XP）
    - **ルール:**
      - 0以上の整数であること
      - 累計XP上限（10500）以下であること

## 6. 外部連携

- **VRChat Persistence API（PlayerData）**
  - **目的:** スキルレベル・XPの永続化
  - **主要なやり取り:**
    - ワールド入場時：`PlayerData.GetInt("Woodcutting_Level")` で読み込み
    - XP獲得時：`PlayerData.SetInt("Woodcutting_XP", newXP)` で保存
    - レベルアップ時：`PlayerData.SetInt("Woodcutting_Level", newLevel)` で保存
  - **制約:** 100KB制限（本機能の使用量：約20バイト）

## 7. 非機能要件（プロトタイプ向け抜粋）

- **性能:**
  - XP計算・レベルアップ判定は50ms以内に完了すること
  - PlayerDataへの保存は非同期で行い、ゲームプレイを阻害しないこと

- **データ整合性:**
  - レベルとXPの整合性チェックを行うこと（例：Lv5なのにXP=50は異常）
  - 異常値検出時は、安全な値（Lv1、XP=0）にリセットすること

## 8. 前提条件・制約事項・スコープ外

- **前提条件:**
  - ユーザーがVRChatアカウントを持ち、Persistence機能が有効であること

- **制約事項:**
  - スキルレベルの最大値は10（Phase 1）
  - Woodcuttingスキルのみ実装（Carrying/Craftingスキルは Phase 2）

- **スコープ外 (Phase 1では実装しないこと):**
  - スキルレベルのリセット機能
  - スキルツリー（分岐選択）→ Phase 2 で Lv6分岐実装予定
  - 経験値ブーストアイテム
  - スキルレベルの上限解放（Lv10以上）

---

# FNC-005: 経済システム

## 1. 仕様概要

- **機能ID:** `FNC-005`

- **機能名:** 経済システム（Economy System）

- **背景と目的:**
  - きこりコインの獲得と使用により、プレイヤーの作業に明確な報酬を提供する
  - ショップでの斧スキン購入により、視覚的な進捗表現と目標設定を実現する
  - 初回ログインボーナスにより、新規ユーザーの離脱を防ぐ
  - PRDの「継続プレイへの動機付けの弱さ」という課題を解決する

- **成功指標:**
  - ユーザーの70%が初回訪問で50コイン以上獲得する
  - ユーザーの30%が斧スキンを1つ以上購入する
  - コイン獲得から購入までの平均時間が15分以内（目標達成の速度感）

## 2. ユーザーとシナリオ

- **対象ユーザー:**
  - プライマリ：すべてのユーザー（伐採・運搬でコイン獲得）
  - セカンダリ：コレクター志向のユーザー（すべての斧スキン収集）

- **ユーザーストーリー:**
  - `As a ユーザー, I want to 作業するたびにコインを獲得したい, so that 努力が報われる.`
  - `As a ユーザー, I want to 貯めたコインで斧スキンを買いたい, so that 見た目をカスタマイズできる.`
  - `As a 新規ユーザー, I want to 初回ログインでボーナスコインをもらいたい, so that すぐにショップを体験できる.`

## 3. 機能要件

### 3.1. 機能の振る舞い

#### 正常系 (Happy Path)

1. **コイン獲得（伐採）**
   - ユーザーが木を伐採完了すると、木の種類に応じたコインを獲得：
     - 小さい木（Pine）：3コイン
     - 中くらいの木（Oak）：5コイン
     - 大きな木（Ancient）：10コイン
   - 協力伐採時：+2コイン
   - 画面中央上部に「+5コイン」という通知が1秒間表示
   - HUD左下のコイン残高がカウントアップアニメーションで増加

2. **コイン獲得（運搬）**
   - FNC-002（運搬システム）により、丸太納品時にコイン獲得
   - 10m運搬 = 3コイン、最大100m = 30コイン

3. **初回ログインボーナス**
   - ユーザーが初めてワールドに入場すると、以下が発生：
     - PlayerData["FirstVisit"]が空の場合、現在日時を記録
     - 50コインを自動付与
     - 画面中央に「ようこそ！初回ログインボーナス 50コイン」という通知を5秒間表示
     - 金色のパーティクルエフェクト

4. **デイリーボーナス**
   - ユーザーが前回訪問から24時間以上経過してワールドに入場すると：
     - 20コインを自動付与
     - 「デイリーボーナス 20コイン」という通知を3秒間表示

5. **ショップアクセス**
   - ユーザーがキャンプ中央の商人NPCテントに近づく
   - 「ショップを開く [E]」というプロンプトが表示される
   - Eキー（VRではトリガー）でショップUIパネルが開く

6. **ショップUI**
   - 3列グリッド形式で商品が表示される：
     - 鉄の斧：100コイン（ダメージ+50%）
     - 黒鋼の斧：300コイン（ダメージ+100%、クリティカル10%）※Woodcutting Lv5必要
     - 作業帽（赤）：50コイン
     - 作業帽（青）：50コイン
     - 作業帽（緑）：50コイン
     - 丸太運搬ベルト：150コイン（移動速度デバフ-5%軽減）
     - ゴールデン斧（装飾）：1000コイン（光る）※Woodcutting Lv10必要
   - 各商品に価格、効果、解禁条件が表示される
   - 購入済みアイテムには「所持中」バッジ
   - 条件未達のアイテムはグレーアウト

7. **購入処理**
   - ユーザーがアイテムを選択し、「購入」ボタンをクリック
   - 確認ダイアログが表示：「鉄の斧を100コインで購入しますか？」
   - 「はい」を選択すると、以下が発生：
     - コイン残高チェック（不足時はエラー）
     - コイン減算（残高 245 → 145）
     - アイテムIDをPlayerData["UnlockedAxeSkins"]配列に追加
     - 購入完了演出（キラキラエフェクト、「購入完了！」通知）
     - ショップUIの「所持中」バッジ更新

8. **装備変更**
   - ユーザーがショップUIで所持中のアイテムを選択し、「装備」ボタンをクリック
   - 装備中の斧が即座に変更され、ダメージ計算に反映される
   - PlayerData["EquippedAxeSkin"]が更新される

9. **データ永続化**
   - コイン獲得時、累計コインと現在残高をPlayerDataに保存：
     - `PlayerData.SetInt("WoodcutterCoins", currentCoins)`
     - `PlayerData.SetInt("TotalCoinsEarned", totalCoins)`
   - 購入時、解禁アイテムリストと装備中アイテムを保存
   - 次回入場時、これらのデータが読み込まれる

#### 異常系 (Error/Edge Cases)

- **ケース1: コイン不足での購入試行**
  - **トリガー:** ユーザーが残高50コインで100コインのアイテムを購入しようとする
  - **システムの振る舞い:** エラー音（ブブー）と「コイン不足です（50/100）」というメッセージが表示される。購入は実行されない

- **ケース2: 解禁条件未達での購入試行**
  - **トリガー:** ユーザーがWoodcutting Lv3で、Lv5必要な黒鋼の斧を購入しようとする
  - **システムの振る舞い:** 「Woodcutting Lv5に到達すると購入できます」というメッセージが表示される。購入ボタンが無効化されている

- **ケース3: 同時購入のダブルクリック**
  - **トリガー:** ユーザーが購入ボタンを誤って2回クリックする
  - **システムの振る舞い:** 1回目の購入処理が完了するまで、2回目のクリックは無効化される（ボタン無効化）。二重購入は発生しない

- **ケース4: コイン上限超過**
  - **トリガー:** ユーザーが既に99,999コイン持っている状態でコインを獲得する
  - **システムの振る舞い:** コインは99,999で固定され、それ以上増加しない。「コイン所持上限に達しています」というメッセージが表示される

## 4. UI/UXフロー

- **画面遷移:**
  1. ユーザーが商人NPCテントに近づくと、「ショップを開く [E]」プロンプト表示
  2. EキーでショップUIパネルがフェードイン（0.3秒）
  3. 商品グリッドが表示され、各商品にカーソルを合わせると詳細情報が表示
  4. 購入ボタンクリック → 確認ダイアログ表示
  5. 「はい」選択 → 購入処理 → キラキラエフェクト → 「購入完了！」通知
  6. ショップUI更新（残高減少、「所持中」バッジ追加）
  7. 閉じるボタン（×）またはEscキーでショップUIがフェードアウト

## 5. データ要件

- **主要データエンティティ:**

  - **エンティティ名:** CoinData（コインデータ）
    - **主要属性:**
      - `currentCoins` (int): 現在の所持コイン（0〜99,999）
      - `totalCoinsEarned` (int): 累計獲得コイン
      - `totalCoinsSpent` (int): 累計消費コイン

  - **エンティティ名:** ShopItem（ショップアイテム）
    - **主要属性:**
      - `itemID` (int): アイテム識別子（1=鉄斧、2=黒鋼斧、...）
      - `itemName` (string): アイテム名
      - `price` (int): 価格（コイン）
      - `requiredLevel` (int): 必要スキルレベル（0=なし）
      - `effect` (string): 効果説明

  - **エンティティ名:** PlayerInventory（プレイヤー所持品）
    - **主要属性:**
      - `unlockedItems` (int[]): 解禁済みアイテムID配列
      - `equippedAxe` (int): 装備中の斧ID
      - `equippedHat` (int): 装備中の帽子ID

- **入力バリデーション:**

  - **項目名:** purchasePrice（購入価格）
    - **ルール:**
      - 所持コイン以下であること
      - 正の整数であること

  - **項目名:** itemID（購入アイテムID）
    - **ルール:**
      - 有効なアイテムIDであること（1〜7の範囲）
      - 既に購入済みでないこと（重複購入防止）

## 6. 外部連携

- **VRChat Persistence API（PlayerData）**
  - **目的:** コイン残高、解禁アイテム、装備の永続化
  - **主要なやり取り:**
    - 入場時：`PlayerData.GetInt("WoodcutterCoins")` でコイン読み込み
    - コイン獲得時：`PlayerData.SetInt("WoodcutterCoins", newCoins)` で保存
    - 購入時：`PlayerData.SetInt("UnlockedAxeSkins", itemID)` で追加

## 7. 非機能要件（プロトタイプ向け抜粋）

- **性能:**
  - ショップUIの開閉は300ms以内に完了すること
  - 購入処理（コイン減算、データ保存）は500ms以内に完了すること

- **ユーザビリティ:**
  - ショップUIは見やすく、各商品の効果が一目で分かること
  - 購入確認ダイアログにより、誤購入を防ぐこと

## 8. 前提条件・制約事項・スコープ外

- **前提条件:**
  - ユーザーがFNC-001（伐採）またはFNC-002（運搬）でコインを獲得済みであること

- **制約事項:**
  - コイン所持上限：99,999コイン
  - Phase 1の商品数：7種類のみ

- **スコープ外 (Phase 1では実装しないこと):**
  - コスメアイテムの大量追加 → Phase 2
  - コイン以外の通貨（キャンプポイントなど）→ Phase 2
  - アイテムの売却機能
  - ギフト機能（他プレイヤーへのコインまたはアイテム譲渡）
  - ガチャシステム

---

# FNC-006: 協力・ソーシャル機能

## 1. 仕様概要

- **機能ID:** `FNC-006`

- **機能名:** 協力・ソーシャル機能（Social Features）

- **背景と目的:**
  - デイリーランキングにより、プレイヤー間の健全な競争を促進する
  - ステータスアイコンにより、他プレイヤーの活動が一目で分かり、会話のきっかけを提供する
  - インスタンス内の協力プレイを可視化し、コミュニティ感を醸成する
  - PRDの「会話のきっかけ不足」「協力プレイの必然性不足」という課題を解決する

- **成功指標:**
  - ユーザーの40%がランキングTOP3に1回以上入る（競争の活性化）
  - ステータスアイコンを見て他プレイヤーに話しかけた割合が20%以上（会話促進）
  - インスタンス内のプレイヤー同士の会話時間が平均15分以上

## 2. ユーザーとシナリオ

- **対象ユーザー:**
  - プライマリ：複数人で遊ぶすべてのユーザー
  - セカンダリ：競争を楽しむユーザー、ソーシャル志向のユーザー

- **ユーザーストーリー:**
  - `As a ユーザー, I want to 今日の伐採王を競いたい, so that ゲーム性が増して楽しい.`
  - `As a ユーザー, I want to 他のプレイヤーが何をしているか一目で分かりたい, so that 話しかけやすい.`
  - `As a ユーザー, I want to 協力伐採した回数を確認したい, so that 協力プレイの成果を実感できる.`

## 3. 機能要件

### 3.1. 機能の振る舞い

#### 正常系 (Happy Path)

1. **ランキングボードの表示**
   - キャンプ中央広場に2m × 3mの木製掲示板が常設されている
   - ボードには以下が表示される：
     ```
     ===== 本日の伐採王 =====
     🥇 1位: PlayerName_A - 42本
     🥈 2位: PlayerName_B - 38本
     🥉 3位: PlayerName_C - 31本
     ========================
     ```
   - ランキングは30秒ごとに自動更新される
   - インスタンス作成時にリセットされる（デイリー＝インスタンス内のみ）

2. **ランキングデータの収集**
   - ユーザーが木を伐採完了すると、以下が発生：
     - UdonSynced配列 `playerCutCounts[playerID]` が +1 される
     - UdonSynced配列 `playerNames[playerID]` にプレイヤー名が記録される
   - Master Clientが30秒ごとにソート処理を実行
   - TOP3のデータがランキングボードに反映される

3. **ステータスアイコンの表示**
   - ユーザーの行動に応じて、頭上1.5mにアイコンが表示される：
     - ⚒️ 斧アイコン：木を伐採中
     - 📦 箱アイコン：丸太運搬中
     - ⚙️ 歯車アイコン：加工作業中
     - 💤 Zzzアイコン：5分間無操作
     - ⭐ 星アイコン：Woodcutting Lv10到達（常時表示）
   - アイコンはWorldSpace Canvasで実装、常にカメラを向く（ビルボード）
   - フェードイン/アウト（0.3秒）で自然に表示切り替え

4. **ステータスアイコンの更新**
   - 伐採開始時：斧アイコン表示
   - 伐採完了時：斧アイコン非表示
   - 丸太Pickup時：箱アイコン表示
   - 丸太Drop時：箱アイコン非表示
   - 加工開始時：歯車アイコン表示
   - 加工完了時：歯車アイコン非表示
   - 5分間操作なし：Zzzアイコン表示（任意の操作で消滅）

5. **協力伐採回数の表示**
   - ランキングボードの下部に、インスタンス全体の統計が表示される：
     ```
     本日の協力伐採: 18回
     総伐採数: 127本
     ```
   - 協力伐採が発動するたびに `totalCooperativeCuts` がインクリメント

#### 異常系 (Error/Edge Cases)

- **ケース1: プレイヤー数が3人未満**
  - **トリガー:** インスタンス内のプレイヤーが2人以下の状態でランキング表示
  - **システムの振る舞い:** ランキングボードに存在するプレイヤーのみ表示。3位まで埋まらない場合は空欄

- **ケース2: 同率順位**
  - **トリガー:** 2人のプレイヤーが同じ伐採数（例：42本）でランキング表示
  - **システムの振る舞い:** 伐採完了時刻が早い方を上位とする。時刻も同じ場合はプレイヤーID順

- **ケース3: Master Clientの退出**
  - **トリガー:** ランキング管理を担当するMaster Clientがワールドから退出
  - **システムの振る舞い:** 新しいMaster Clientにランキングデータ（UdonSynced配列）が自動引き継がれ、ソート処理も継続

- **ケース4: ステータスアイコンの重複表示**
  - **トリガー:** ユーザーが伐採中に丸太をPickupしようとする（理論上は発生しにくい）
  - **システムの振る舞い:** 優先度の高いアイコン（斧 > 箱 > 歯車 > Zzz）のみ表示。複数同時表示はしない

## 4. UI/UXフロー

- **画面遷移:**
  1. ユーザーがワールド入場時、ランキングボードが視認できる位置に配置されている
  2. ボードに近づくと、現在のランキングが鮮明に表示される
  3. ユーザーが伐採開始すると、自分の頭上に斧アイコンが出現（0.3秒フェードイン）
  4. 他のプレイヤーから見ても、そのユーザーの頭上にアイコンが見える
  5. 伐採完了時、アイコンが消える（0.3秒フェードアウト）
  6. 30秒ごとにランキングボードが更新され、順位変動がある場合は変化を視覚的に強調（該当プレイヤー行がハイライト）

## 5. データ要件

- **主要データエンティティ:**

  - **エンティティ名:** RankingData（ランキングデータ）
    - **主要属性:**
      - `playerNames` (string[]): プレイヤー名配列（最大20人）
      - `playerCutCounts` (int[]): 各プレイヤーの伐採数
      - `playerCompletionTimes` (float[]): 各プレイヤーの最終伐採時刻
      - `topThreePlayers` (string[]): TOP3のプレイヤー名
      - `topThreeCounts` (int[]): TOP3の伐採数

  - **エンティティ名:** StatusIcon（ステータスアイコン）
    - **主要属性:**
      - `iconType` (enum): アイコン種別（Axe=0, Box=1, Gear=2, Zzz=3, Star=4）
      - `isVisible` (bool): 表示中フラグ
      - `fadeTimer` (float): フェードアニメーション用タイマー

  - **エンティティ名:** InstanceStats（インスタンス統計）
    - **主要属性:**
      - `totalTreesCutToday` (int): 本日の総伐採数
      - `totalCooperativeCuts` (int): 協力伐採回数
      - `instanceStartTime` (float): インスタンス開始時刻

- **入力バリデーション:**

  - **項目名:** playerCutCount（プレイヤー伐採数）
    - **ルール:**
      - 0以上の整数であること
      - 1000以下であること（異常値防止）

  - **項目名:** playerID（プレイヤー識別子）
    - **ルール:**
      - 0〜19の範囲内であること（配列インデックス）
      - 有効なプレイヤーであること（退出済みでない）

## 6. 外部連携

- **VRChat UdonSync（ネットワーク同期）**
  - **目的:** ランキングデータ、インスタンス統計をすべてのプレイヤーに同期
  - **主要なやり取り:**
    - 伐採完了時：`[UdonSynced] int[] playerCutCounts` を更新
    - 30秒ごと：Master ClientがTOP3を計算し、`[UdonSynced] string[] topThreePlayers` を更新
    - 協力伐採発動時：`[UdonSynced] int totalCooperativeCuts` をインクリメント

## 7. 非機能要件（プロトタイプ向け抜粋）

- **性能:**
  - ランキングのソート処理は10ms以内に完了すること（20人分のデータ）
  - ステータスアイコンの表示/非表示切り替えは50ms以内に完了すること

- **ユーザビリティ:**
  - ランキングボードのフォントサイズは、5m離れた位置からも読めること
  - ステータスアイコンはプレイヤーの視界を妨げないサイズ（0.3m × 0.3m）とすること

## 8. 前提条件・制約事項・スコープ外

- **前提条件:**
  - インスタンス内に2人以上のプレイヤーがいること（1人の場合もランキング表示は可能）

- **制約事項:**
  - ランキングはインスタンス単位（インスタンス作成時にリセット）
  - 最大プレイヤー数：20人（VRChat標準制限）

- **スコープ外 (Phase 1では実装しないこと):**
  - グローバルランキング（全インスタンス横断）→ Phase 3
  - 実績システム（トロフィー、称号など）→ Phase 2
  - クエストボード → Phase 2
  - 撮影スポット → Phase 2
  - エモートシステム（Phase 1では基本エモートのみ、カスタムエモートは Phase 2）

---

## 付録A: データ構造サマリ

### PlayerData（永続化データ）構造

```json
{
  "Woodcutting_Level": 5,
  "Woodcutting_XP": 1650,
  "WoodcutterCoins": 245,
  "UnlockedAxeSkins": [1, 2],
  "EquippedAxeSkin": 2,
  "UnlockedHats": [1, 3, 5],
  "EquippedHat": 3,
  "TotalTreesCut": 156,
  "TotalLogsCarried": 89,
  "TotalCoinsEarned": 1420,
  "PlayTime": 7200,
  "LastVisit": "2025-11-16T10:00:00Z",
  "FirstVisit": "2025-11-01T15:30:00Z",
  "TutorialCompleted": true,
  "Version": "1.0.0"
}
```

### UdonSynced変数（インスタンス共有）構造

```csharp
// プレイヤー統計
[UdonSynced] string[] playerNames = new string[20];
[UdonSynced] int[] playerCutCounts = new int[20];
[UdonSynced] int[] playerCoins = new int[20];
[UdonSynced] int[] playerLevels = new int[20];

// 木の状態管理
[UdonSynced] int[] treeHPs = new int[30];
[UdonSynced] bool[] treeFallen = new bool[30];
[UdonSynced] float[] treeRespawnTimers = new float[30];

// 協力伐採管理
[UdonSynced] int[] cooperativeHitTimestamps = new int[20];
[UdonSynced] int[] cooperativeTreeIDs = new int[20];

// システム状態
[UdonSynced] float instanceStartTime;
[UdonSynced] int totalTreesCutToday;
[UdonSynced] int totalCooperativeCuts;
```

---

## 付録B: エラーメッセージ一覧

| エラーコード | メッセージ | 表示条件 | 対処法 |
|------------|-----------|---------|--------|
| ERR-001 | 斧を装備してください | 斧なしで木を攻撃 | 斧置き場で斧を取得 |
| ERR-002 | コイン不足です（X/Y） | 購入時にコイン不足 | コインを獲得する |
| ERR-003 | Woodcutting LvXに到達すると購入できます | 解禁条件未達 | スキルレベルを上げる |
| ERR-004 | 丸太を配置してください | 切断台に丸太なし | 丸太を配置する |
| ERR-005 | 納品エリアに運んでください | 納品エリア外でDrop | 納品エリアまで運ぶ |
| ERR-006 | 板材が不足しています（X/Y） | クラフト時に素材不足 | 板材を作成する |
| ERR-007 | すでに誰かが持っています | 丸太の同時Pickup試行 | 別の丸太を探す |
| ERR-008 | 加工中は移動できません | 加工中の丸太Pickup試行 | 加工完了まで待つ |
| ERR-009 | コイン所持上限に達しています | 99,999コイン超過 | コインを使用する |
| ERR-010 | 最大レベルに到達しています | Lv10でXP獲得 | 情報メッセージ（エラーではない） |

---

## 付録C: パフォーマンス目標値

| 項目 | 目標値 | 測定方法 | 環境 |
|------|--------|---------|------|
| 斧スイングレスポンス | < 100ms | 入力からヒット判定まで | すべて |
| 倒木アニメーション開始 | < 200ms | HP=0から開始まで | すべて |
| ランキング更新 | < 10ms | ソート処理時間 | すべて |
| Pickup/Drop処理 | < 50ms | イベント発火から完了まで | すべて |
| データ保存 | < 500ms | PlayerData書き込み | すべて |
| FPS（Quest 2） | 60fps | 10人同時伐採時 | Quest 2 |
| FPS（PC VR） | 90fps | 20人同時伐採時 | PC VR |
| ネットワーク帯域 | < 5KB/秒 | 全同期データ合計 | すべて |

---

## 付録D: SOLID原則の適用

本FSDで記述された各機能は、以下のSOLID原則に準拠して実装されることを想定している：

1. **Single Responsibility Principle（単一責任の原則）**
   - TreeControllerは木の状態管理のみ、ダメージ計算はSkillEffectsに委譲
   - CoinManagerはコイン管理のみ、ショップUIはShopUIに委譲

2. **Open/Closed Principle（開放閉鎖の原則）**
   - 新しい斧スキン追加は、ScriptableObjectで管理し、コード変更不要
   - 新しいクラフトレシピ追加も、ScriptableObjectで管理

3. **Liskov Substitution Principle（リスコフの置換原則）**
   - VRC_Pickupを継承したカスタムPickupクラスでも、同じインターフェースで動作

4. **Interface Segregation Principle（インターフェース分離の原則）**
   - AxeInteractionは攻撃判定のみ、音・エフェクトは別モジュール
   - ShopUIは購入処理のみ、装備管理は別モジュール

5. **Dependency Inversion Principle（依存性逆転の原則）**
   - TreeControllerはISkillManagerインターフェースに依存（具体実装に依存しない）
   - ShopUIはICoinManagerインターフェースに依存

---

**文書管理情報**
- 作成者：VRChatワールド開発チーム
- 承認者：（Phase 1実装開始前に承認必要）
- 最終レビュー日：2025-11-16
- 次回レビュー予定：Phase 1実装完了後

---
